===================================================================
RCS file: /cvsroot/installer/poldek/pkgset-install.c,v
retrieving revision 1.147
retrieving revision 1.148
diff -u -r1.147 -r1.148
--- installer/poldek/pkgset-install.c	2005/10/24 15:30:40	1.147
+++ installer/poldek/pkgset-install.c	2005/11/01 19:36:36	1.148
 #ifdef HAVE_CONFIG_H
@@ -1174,7 +1174,9 @@
     memset(&successor, 0, sizeof(successor));
     if (process_as == PROCESS_AS_ORPHAN &&
         upg->ts->getop(upg->ts, POLDEK_OP_AGGREEDY)) {
-        if (pkg_drags(pkg, ps, upg) == 0) {
+	int ndrags = pkg_drags(pkg, ps, upg);
+	DBGF("%s, ndrags %d\n", pkg_id(pkg), ndrags);
+        if (ndrags == 0 || 1) { /* XXX cond temporary disabled - needs test */
             struct pkg *p;
             int is_marked = 0, ndragged = 0, by_obsoletes = 0;
 
@@ -1186,9 +1188,10 @@
             successor.realpkg = p;
             successor.by_obsoletes = by_obsoletes;
             
-            /* do not follow successor if package drags something and
-              is not marked */
-            if (p && (ndragged = pkg_drags(p, ps, upg)) > 0 && is_marked == 0) {
+            /* do not follow successor if it drags more packages than orphaned one
+	     * and successor is not marked */
+	    
+            if (p && (ndragged = pkg_drags(p, ps, upg)) > ndrags && is_marked == 0) {
                 DBGF("OMIT select_successor %s -> %s (%d)\n",
                      pkg_id(pkg), pkg_id(p), ndragged);
                 p = NULL;
===================================================================
RCS file: /cvsroot/installer/poldek/vfile/misc.c,v
retrieving revision 1.11
retrieving revision 1.12
diff -u -r1.11 -r1.12
--- installer/poldek/vfile/misc.c	2005/07/17 15:04:34	1.11
+++ installer/poldek/vfile/misc.c	2005/11/02 19:45:40	1.12
@@ -58,7 +58,7 @@
     
     p = path;
     p++;
-    ndots = 0;
+    ndots = -1;
     
     while (*p) {
         switch (*p) {
@@ -71,11 +71,12 @@
                 break;
 
             case '.':
-                ndots++;
+                if (ndots >= 0)
+                    ndots++;
                 break;
 
             default:
-                ndots = 0;
+                ndots = -1;
                 
                 if (!isalnum(*p) && strchr("-+/._@!~", *p) == NULL) {
                     vf_logerr("%s:%c non alphanumeric characters not allowed\n",
===================================================================
RCS file: /cvsroot/installer/poldek/vfile/extcompr.c,v
retrieving revision 1.7
retrieving revision 1.8
diff -u -r1.7 -r1.8
--- installer/poldek/vfile/extcompr.c	2005/05/15 15:46:59	1.7
+++ installer/poldek/vfile/extcompr.c	2005/11/02 20:10:36	1.8
@@ -195,7 +195,7 @@
     if (uncompr == NULL)
         return -1;
 
-    if (*vfile_verbose) 
+    if (*vfile_verbose > 0) 
         vf_loginfo(_("Decompressing %s...\n"), n_basenam(path));
     return vf_do_compr(uncompr, "-d", path, destpath);
 }
===================================================================
RCS file: /cvsroot/installer/poldek/cli/uninstall.c,v
retrieving revision 1.25
retrieving revision 1.26
diff -u -r1.25 -r1.26
--- installer/poldek/cli/uninstall.c	2005/07/12 17:29:09	1.25
+++ installer/poldek/cli/uninstall.c	2005/11/05 00:14:38	1.26
@@ -171,6 +171,7 @@
                 
                 ts->setop(ts, POLDEK_OP_GREEDY, bool);
             }
+            break;
             
         case 't':
             if (ts->getop(ts, POLDEK_OP_TEST))
===================================================================
RCS file: /cvsroot/installer/poldek/vfcompr,v
retrieving revision 1.4
retrieving revision 1.6
diff -u -r1.4 -r1.6
--- installer/poldek/vfcompr	2004/07/05 19:15:10	1.4
+++ installer/poldek/vfcompr	2005/11/02 20:25:37	1.6
@@ -19,7 +22,7 @@
     typeset src=$1
     typeset dest=$2
 
-    md5file="${src}-vfcompr.md5"
+    md5file="${dest}-vfcompr.md5"
     #echo "$md5file"
     if [ -f $dest -a -f "$md5file" ]; then
         #echo md5sum --check "$md5file"
===================================================================
RCS file: /cvsroot/poldek/poldek/pkg.c,v
retrieving revision 1.107
retrieving revision 1.108
diff -u -r1.107 -r1.108
--- poldek/poldek/pkg.c	2005/10/13 15:39:27	1.107
+++ poldek/poldek/pkg.c	2006/03/18 16:29:00	1.108
@@ -1,5 +1,5 @@
 /*
-  Copyright (C) 2000 - 2004 Pawel A. Gajda <mis@k2.net.pl>
+  Copyright (C) 2000 - 2006 Pawel A. Gajda (mis@k2.net.pl)
 
   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License, version 2 as
@@ -15,7 +15,7 @@
  */
 
 /*
-  $Id$
+  $Id$
 */
 
 #ifdef HAVE_CONFIG_H
@@ -694,8 +694,8 @@
     int n;
         
     DBGF("\npkg_caps_match_req %s %s\n", pkg_snprintf_s(pkg), 
-         capreq_snprintf_s(req));
-        
+           capreq_snprintf_s(req));
+    
     if (pkg->caps == NULL || n_array_size(pkg->caps) == 0)
         return 0;     /* not match */
     
@@ -703,40 +703,25 @@
         return 0;
             
     } else {
-        struct capreq *cap;
         int i;
+        for (i = n; i < n_array_size(pkg->caps); i++) {
+            struct capreq *cap = n_array_nth(pkg->caps, i);
 
-        cap = n_array_nth(pkg->caps, n);
-        if (cap_xmatch_req(cap, req, flags)) {
-            DBGF("chk%d (%s-%s-%s) -> match (flags=%d)\n", n, capreq_name(cap),
-                 capreq_ver(cap), capreq_rel(cap), flags);
-            return 1;
-        }
-        n++;
-            
-        for (i = n; i<n_array_size(pkg->caps); i++) {
-            struct capreq *cap;
-
-            cap = n_array_nth(pkg->caps, n);
-            if (strcmp(capreq_name(cap), capreq_name(req)) != 0) {
-                DBGF("chk%d %s-%s-%s -> NOT match IRET\n", i,
-                     capreq_name(cap), capreq_ver(cap),
-                     capreq_rel(cap));
+            /* names not equal -> return with false;
+               eq test omitting for first cap */
+            if (i > n && n_str_ne(capreq_name(cap), capreq_name(req))) {
+                DBGF("  cap[%d] %s -> NOT match, IRET\n", i,
+                       capreq_snprintf_s(cap));
                 return 0;
             }
-                
-                
+            
             if (cap_xmatch_req(cap, req, flags)) {
-                DBGMSG("chk %s-%s-%s -> match\n", capreq_name(cap),
-                       capreq_ver(cap), capreq_rel(cap));
+                DBGF("  cap[%d] %s -> match\n", i, capreq_snprintf_s(cap));
                 return 1;
-            } else {
-                DBGMSG("chk%d %s-%s-%s -> NOT match\n", i,
-                       capreq_name(cap), capreq_ver(cap),
-                       capreq_rel(cap));
             }
+            
+            DBGF("  cap[%d] %s -> NOT match\n", i, capreq_snprintf_s(cap));
         }
-        DBGMSG("NONE\n");
     }
     
     return 0;
